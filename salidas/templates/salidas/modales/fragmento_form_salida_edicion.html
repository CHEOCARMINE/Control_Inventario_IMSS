{% csrf_token %}

<!-- Contenedor principal -->
<div class="row">
    <div class="col-md-4 mb-3">
        <label for="id_solicitante">Solicitante</label>
        <select name="solicitante" id="id_solicitante"
                class="form-control select2-solicitante"
                {% if solo_vista %}disabled{% endif %} required>
        <option value="">Selecciona un solicitante…</option>
        {% for s in solicitantes %}
            <option value="{{ s.id }}"
                    data-unidad-id="{{ s.unidad_id }}"
                    data-departamento-id="{{ s.departamento_id }}"
                    {% if s.id == vale.solicitante_id %}selected{% endif %}>
            {{ s.nombre }}
            </option>
        {% endfor %}
        </select>
    </div>

    <div class="col-md-4 mb-3">
        <label for="id_unidad">Unidad</label>
        <select name="unidad" id="id_unidad"
                class="form-control select2-unidad"
                {% if solo_vista %}disabled{% endif %} required>
        <option value="">Selecciona unidad…</option>
        {% for u in unidades %}
            <option value="{{ u.id }}"
                    {% if u.id == vale.unidad_id %}selected{% endif %}>
            {{ u.nombre }}
            </option>
        {% endfor %}
        </select>
    </div>

    <div class="col-md-4 mb-3">
        <label for="id_departamento">Departamento</label>
        <select name="departamento" id="id_departamento"
                class="form-control select2-departamento"
                {% if solo_vista %}disabled{% endif %} required>
        <option value="">Selecciona departamento…</option>
        {% for d in departamentos %}
            <option value="{{ d.id }}"
                    {% if d.id == vale.departamento_id %}selected{% endif %}>
            {{ d.nombre }}
            </option>
        {% endfor %}
        </select>
    </div>
</div>

<!-- Contenedor para motivo de cancelación -->
{% if vale.estado == "cancelado" and vale.motivo_cancelacion %}
    <div class="alert alert-danger mt-2">
        <strong>Motivo de cancelación:</strong><br>
        {{ vale.motivo_cancelacion }}
    </div>
{% endif %}

<hr class="my-2">

<!-- Tabla de productos (con scroll) -->
<div class="formset-scroll-wrapper flex-grow-1">
    <div class="table-responsive">
        <table class="table table-bordered table-sm" id="tabla-editar-salida">
        <thead class="thead-light">
            <tr>
            <th style="width: 25%;">Producto</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Color</th>
            <th>N.º Serie</th>
            <th style="width: 100px;">Cantidad</th>
            <th style="width: 60px;">Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for detalle in detalles %}
            <tr class="linea-form fila-existente" data-producto-id="{{ detalle.producto.id }}">
                <td>
                <select name="producto_id[]" class="form-control select2-producto-auto"
                        {% if solo_vista %}disabled{% endif %}>
                    <option></option>
                    {% for p in productos_disponibles %}
                    <option value="{{ p.id }}"
                        data-marca="{{ p.marca.nombre }}"
                        data-modelo="{{ p.modelo }}"
                        data-color="{{ p.color }}"
                        data-serie="{{ p.numero_serie }}"
                        data-tiene-serie="{{ p.tiene_serie|yesno:'true,false' }}"
                        data-tiene-hijos="{{ p.productos_hijos.count|yesno:'true,false' }}"
                        data-stock="{{ p.stock }}"
                        {% if p.id == detalle.producto.id %}selected{% endif %}>
                        {{ p.tipo.nombre }} – {{ p.nombre }}
                    </option>
                    {% endfor %}
                </select>
                <input type="hidden" name="producto_id[]" value="{{ detalle.producto.producto_padre_id|default:detalle.producto.id }}">
                <input type="hidden" name="producto_hijo_id[]" value="{% if detalle.producto.producto_padre_id %}{{ detalle.producto.id }}{% endif %}">
                </td>
                <td class="marca-cell">{{ detalle.producto.marca.nombre }}</td>
                <td class="modelo-cell">{{ detalle.producto.modelo }}</td>
                <td class="color-cell">{{ detalle.producto.color }}</td>
                <td class="serie-cell">{{ detalle.producto.numero_serie }}</td>
                <td>
                <input name="cantidad[]" 
                        type="number"
                        class="form-control cantidad-input"
                        value="{{ detalle.cantidad }}"
                        {% if solo_vista or detalle.producto.tiene_serie %}readonly{% endif %}>
                </td>
                <td class="text-center align-middle">
                {% if not solo_vista %}
                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-fila">&times;</button>
                {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
</div>

<!-- Botón para agregar filas -->
{% if not solo_vista %}
    <div class="d-flex justify-content-between mt-3">
        <button type="button" id="btn-agregar-fila-edicion" class="btn btn-outline-primary">
        + Agregar fila
        </button>
    </div>
{% endif %}
