<div class="modal-header">
    <h5 class="modal-title">Registrar Entrada de Productos</h5>
    <button type="button" class="close" data-dismiss="modal">&times;</button>
</div>
<div class="modal-body">
    <form id="form-entrada" method="post" action="{% url 'inventario:registrar_entrada' %}">
        <div id="entrada-form-fields">
        {% include 'inventario/modales/fragmento_form_entrada.html' %}
        </div>
        <div class="text-right mt-3">
        <button type="submit" class="btn btn-primary">Guardar Entrada</button>
        </div>
    </form>
</div>

<script>
$(function() {
    // Envío AJAX del formulario de Entrada
    function bindFormEntrada() {
        $('#form-entrada').off('submit').on('submit', function(e) {
        e.preventDefault();
        const form = $(this);
        $.ajax({
            type: 'POST',
            url: form.attr('action'),
            data: form.serialize(),
            success: function(response) {
            if (response.success) {
                $('#modalRegistrarEntrada').modal('hide');
                window.location = response.redirect_url;
            } else {
                // Si hay errores, recargamos solo el bloque del fragmento
                $('#entrada-form-fields').html(response.html_form);
                bindFormEntrada();
                bindBtnsLinea();
                bindNuevoProductoGeneral();
                bindNuevoProductoFila();
            }
            },
            error: function() {
            alert('Error de red. Intenta de nuevo.');
            }
        });
        });
    }

    // Agregar y eliminar filas dinámicas
    function bindBtnsLinea() {
        // “+ Agregar Producto”
        $('#btn-agregar-fila').off('click').on('click', function() {
        const totalFormsInput = $('#id_form-TOTAL_FORMS');
        let formCount = parseInt(totalFormsInput.val(), 10);

        // Clonar la fila oculta (#template-row)
        const nuevaFila = $('#template-row').clone();
        nuevaFila.removeAttr('id').show();
        nuevaFila.attr('data-index', formCount);

        // Reemplazar __INDEX__ en name/id y limpiar valores
        nuevaFila.find('select, input').each(function() {
            const oldName = $(this).attr('name');
            if (!oldName) return;
            const newName = oldName.replace(/__INDEX__/, formCount);
            const newId = 'id_' + newName;
            $(this).attr({ 'name': newName, 'id': newId });

            if ($(this).is('select')) {
            // Asegurarnos que ninguna opción está seleccionada
            $(this).val('');
            }
            if ($(this).is('input[type="number"]')) {
            $(this).val('');
            }
            if ($(this).is('input[type="checkbox"]')) {
            $(this).prop('checked', false).hide();
            }
        });

        // También limpiar las celdas de marca/color/modelo/serie
        nuevaFila.find('.marca-cell').text('');
        nuevaFila.find('.color-cell').text('');
        nuevaFila.find('.modelo-cell').text('');
        nuevaFila.find('.serie-cell').text('');

        $('#tabla-entradas tbody').append(nuevaFila);
        totalFormsInput.val(formCount + 1);

        // Volver a bindear para que la nueva fila tenga eventos
        bindBtnsLinea();
        bindNuevoProductoFila(nuevaFila);
        bindListenerCambioProducto(nuevaFila);
        });

        // 2.2) Botón “×” para eliminar fila
        $('.btn-eliminar-fila').off('click').on('click', function() {
        const row = $(this).closest('tr.linea-form');
        const deleteCheckbox = row.find('input[type="checkbox"][name$="-DELETE"]');

        if (deleteCheckbox.length) {
            // Si la fila ya existía en la base, marcamos DELETE y ocultamos
            deleteCheckbox.prop('checked', true);
            row.hide();
        } else {
            // Si la fila fue recién creada, la eliminamos del DOM y reindexamos
            row.remove();
            const totalFormsInput = $('#id_form-TOTAL_FORMS');
            let formCount = parseInt(totalFormsInput.val(), 10);
            totalFormsInput.val(formCount - 1);

            // Reindexar filas restantes
            $('#tabla-entradas tbody tr.linea-form').each(function(i) {
            $(this).attr('data-index', i);
            $(this).find('select, input').each(function() {
                const oldName = $(this).attr('name') || '';
                const newName = oldName.replace(/-(\d+)-/, `-${i}-`);
                const newId = 'id_' + newName;
                $(this).attr({ 'name': newName, 'id': newId });
            });
            });
        }
        });
    }

    // Cuando el usuario cambia el producto, actualizamos las celdas Marca/Color/Modelo/Serie
    function bindListenerCambioProducto(fila) {
        const selects = fila ? fila.find('.select-producto-auto') : $('.select-producto-auto');
        selects.off('change').on('change', function() {
        const $select = $(this);
        const $row = $select.closest('tr.linea-form');
        const selectedOption = $select.find('option:selected');

        // Leer data-atributos
        const marca = selectedOption.data('marca') || '';
        const color = selectedOption.data('color') || '';
        const modelo = selectedOption.data('modelo') || '';
        const serie = selectedOption.data('serie') || '';

        // Escribir en las celdas correspondientes
        $row.find('.marca-cell').text(marca);
        $row.find('.color-cell').text(color);
        $row.find('.modelo-cell').text(modelo);
        $row.find('.serie-cell').text(serie);
        });
    }

    // “+ Nuevo Producto” en cada fila
    function bindNuevoProductoFila(fila) {
        const selector = fila ? fila.find('.btn-nuevo-producto') : $('.btn-nuevo-producto');
        selector.off('click').on('click', function() {
        const currentRow = $(this).closest('tr.linea-form');
        $.get("{% url 'inventario:crear_producto' %}", function(html) {
            $('#modalCrearProducto .modal-content').html(html);
            $('#modalCrearProducto').modal('show');

            $('#modalCrearProducto').off('submitSuccess').on('submitSuccess', function(e, data) {
            // 1) Insertar la nueva opción en el select de la fila actual
            const newOption = new Option(data.producto_label, data.producto_id, true, true);
            currentRow.find('select[name$="-producto"]').append(newOption).trigger('change');
            $('#modalCrearProducto').modal('hide');
            });
        });
        });
    }

    // “+ Nuevo Producto” general (inyecta opción en todos los selects)
    function bindNuevoProductoGeneral() {
        $('#btn-nuevo-producto-general').off('click').on('click', function() {
        $.get("{% url 'inventario:crear_producto' %}", function(html) {
            $('#modalCrearProducto .modal-content').html(html);
            $('#modalCrearProducto').modal('show');

            $('#modalCrearProducto').off('submitSuccess').on('submitSuccess', function(e, data) {
            $('.select-producto-auto').each(function() {
                const $sel = $(this);
                const newOption = new Option(data.producto_label, data.producto_id, false, false);
                $sel.append(newOption);
            });
            $('#modalCrearProducto').modal('hide');
            });
        });
        });
    }

    // Inicializar todo cuando el modal se abre / se recarga
    bindFormEntrada();
    bindBtnsLinea();
    bindListenerCambioProducto();
    bindNuevoProductoGeneral();
    bindNuevoProductoFila();
});
</script>

<!-- Modal para “Crear Producto al vuelo” -->
<div class="modal fade" id="modalCrearProducto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content"><!-- Carga modal_crear_producto.html vía AJAX --></div>
    </div>
</div>
